// Generated by CoffeeScript 1.4.0
(function() {

  angular.module('tmg').controller('RpnCtrl', [
    '$scope', '$state', '$rootScope', '$api', '$cookies', function($scope, $state, $rootScope, $api, $cookies) {
      var requestIin;
      $scope.is = {
        iin: true,
        keyboard: false,
        queue: true,
        tied: false
      };
      $scope.iin = null;
      $scope.$watch(function() {
        return $scope.iin;
      }, function(newvalue, oldvalue) {
        if (newvalue) {
          console.log(newvalue.length);
          if (newvalue.length === 12) {
            $scope.is.keyboard = false;
            return requestIin(newvalue);
          } else if (newvalue.length === 0) {
            return $scope.iin = null;
          }
        }
      });
      $scope.append = function(char) {
        if ($scope.iin) {
          return $scope.iin += char;
        } else {
          return $scope.iin = char;
        }
      };
      $scope.clear = function() {
        return $scope.iin = $scope.iin.substring(0, $scope.iin.length - 1);
      };
      $scope.person = null;
      $scope.keys = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
      $scope.cancelNotTied = function() {
        $scope.is.iin = true;
        $scope.is.queue = true;
        $scope.is.tied = false;
        $scope.iin = null;
        return $scope.person = null;
      };
      $scope.iinNotExists = false;
      requestIin = function(iin) {
        $rootScope.loading = true;
        return $api.rpn.person(iin, function(data) {
          $rootScope.loading = false;
          $scope.iinNotExists = data.length === 0;
          $scope.is.iin = false;
          if (!$scope.iinNotExists) {
            console.log('not empty');
            $scope.iinNotExists = data.plain()[0].isDel;
          }
          if (!$scope.iinNotExists) {
            console.log('exists');
            $scope.person = data.plain()[0];
            if ($scope.person.activeAttachment) {
              $api.rpn.territory.get($scope.person.activeAttachment.territoryServiceID, function(data) {
                return console.log(data);
              });
              return $api.rpn.territory.org($scope.person.activeAttachment.orgHealthCare.id, function(data) {
                return console.log(data);
              });
            }
          }
        });
      };
      return $scope.home = function() {
        return $state.transitionTo('home');
      };
    }
  ]);

}).call(this);
